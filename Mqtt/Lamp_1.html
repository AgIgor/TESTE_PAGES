<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L√¢mpada Animada ‚Äî Dimmer, Cor e MQTT</title>
  <style>
    :root{
      --bg:#0f1724; --panel:#0b1220; --muted:#9aa5b1; --accent:#ffd166; --lamp-off:#2b3742; --lamp-glow: rgba(255,209,102,0.14);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fb; --panel:#ffffff; --muted:#5b6b77; --accent:#ffb703; --lamp-off:#cbd5df; --lamp-glow: rgba(255,183,3,0.15);} }
    html,body{height:100%;}
    body{margin:0;display:flex;align-items:center;justify-content:center; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,var(--bg), #071021 120%); color:var(--muted); padding:20px}
    .card{width:min(880px,96vw); background:linear-gradient(180deg,rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:18px; box-shadow:0 10px 40px rgba(2,6,23,0.6); display:grid; grid-template-columns:1fr 360px; gap:18px}
    @media (max-width:820px){ .card{grid-template-columns:1fr; padding:14px} }
    .stage{min-height:360px; display:flex;align-items:center;justify-content:center;position:relative}
    .bulb-wrap{width:320px; max-width:70vw;}
    svg{display:block;width:100%;height:auto}
    .glow{position:absolute; left:50%; transform:translateX(-50%); top:10%; width:420px; height:420px; border-radius:50%; pointer-events:none; filter:blur(34px); transition:opacity .28s ease, background .28s ease, transform .3s ease; opacity:0; mix-blend-mode:screen}
    .controls{display:flex;flex-direction:column;gap:12px;padding:6px}
    .label{font-weight:700;color:var(--muted);}
    .row{display:flex;gap:10px;align-items:center}
    .group{background:rgba(255,255,255,0.02); padding:12px;border-radius:10px}
    .switch{--size:76px;width:var(--size);height:var(--size);border-radius:999px;background:linear-gradient(180deg,var(--panel), rgba(255,255,255,0.02));display:flex;align-items:center;justify-content:center;box-shadow:inset 0 -6px 12px rgba(0,0,0,0.35), 0 6px 18px rgba(2,6,23,0.6);cursor:pointer;position:relative;transition:transform .18s ease}
    .knob{width:48px;height:48px;border-radius:50%;background:var(--lamp-off);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(2,6,23,0.5);transition:transform .25s cubic-bezier(.2,.9,.3,1), background .22s ease}
    .switch:active{transform:scale(.98)}
    .on .knob{background:var(--accent)}
    .flicker{animation:flicker 700ms both}
    @keyframes flicker{0%{opacity:0.92}5%{opacity:0.7}12%{opacity:1}20%{opacity:0.9}30%{opacity:1}100%{opacity:1}}
    @keyframes filamentPulse{0%{opacity:0.9; transform:translateY(0)}50%{opacity:1; transform:translateY(-1px)}100%{opacity:0.9; transform:translateY(0)}}
    .filament{transform-origin:center; transition:opacity .3s ease}
    .on .filament{animation:filamentPulse 900ms infinite}
    input[type=range]{width:100%}
    .hint{font-size:13px;color:var(--muted); text-align:center}
    label{font-size:13px;color:var(--muted)}
    input[type=text], input[type=number], input[type=password]{width:100%; padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#081020;font-weight:700;cursor:pointer}
    .status{font-size:13px;padding:8px;border-radius:8px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="card" id="card">
    <div>
      <div class="stage">
        <div class="glow" id="glow" style="background:radial-gradient(circle at 50% 35%, rgba(255,200,80,0.22), transparent 40%);"></div>
        <div class="bulb-wrap" id="bulbWrap">
          <!-- SVG l√¢mpada com filamento -->
          <svg viewBox="0 0 200 360" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <filter id="softBlur"><feGaussianBlur stdDeviation="6" result="b"/></filter>
            </defs>
            <g transform="translate(0,8)">
              <ellipse cx="100" cy="110" rx="64" ry="80" fill="rgba(255,255,255,0.02)"/>
              <path id="glass" d="M60 90 C36 126 36 176 68 218 C92 252 108 252 132 218 C164 176 164 126 140 90 C132 74 120 60 100 60 C80 60 68 74 60 90 Z" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="2"/>

              <!-- filamento -->
              <g id="filament" class="filament" transform="translate(0,0)">
                <path id="f1" d="M100 118 C98 128 86 138 86 148 C86 168 110 168 110 148 C110 138 100 128 100 118 Z" fill="none" stroke="rgba(255,160,40,0.95)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.0" />
                <path id="f2" d="M86 148 C86 160 90 170 100 170 C110 170 114 160 114 148" fill="none" stroke="rgba(255,210,110,0.95)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.0"/>
              </g>

              <!-- soquete -->
              <rect x="72" y="220" width="56" height="40" rx="6" fill="rgba(255,255,255,0.03)" stroke="rgba(0,0,0,0.2)"/>
              <rect x="78" y="240" width="44" height="24" rx="4" fill="rgba(0,0,0,0.15)"/>

              <!-- metal base rings -->
              <g transform="translate(72,262)">
                <rect x="-4" y="0" width="88" height="8" rx="3" fill="rgba(255,255,255,0.02)"/>
                <rect x="2" y="10" width="76" height="8" rx="3" fill="rgba(255,255,255,0.01)"/>
              </g>
            </g>
          </svg>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
        <div class="group" style="flex:1;min-width:220px;">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <div class="label">Ligar / Desligar</div>
            <div class="switch" id="switch" role="button" aria-pressed="false" tabindex="0" title="Ligar/Desligar">
              <div class="knob" id="knob">üí°</div>
            </div>
          </div>
        </div>

        <div class="group" style="width:260px;min-width:180px;">
          <div class="label">Brilho (Dimmer)</div>
          <input id="brightness" type="range" min="0" max="100" value="100" />
          <div class="hint muted" id="brightVal">100%</div>
        </div>

        <div class="group" style="width:140px;min-width:120px;">
          <div class="label">Cor</div>
          <input id="color" type="color" value="#ffd166" style="width:100%;height:42px;border-radius:8px;padding:2px;border:none;" />
        </div>
      </div>
    </div>

    <aside class="controls">
      <div class="group">
        <div class="label">MQTT (WebSocket)</div>
        <div style="display:grid;gap:8px;margin-top:8px;">
          <label>Broker (ws:// ou wss://)</label>
          <input id="broker" type="text" placeholder="ex: ws://broker.hivemq.com:8000/mqtt" />
          <label>Port (opcional)</label>
          <input id="port" type="number" placeholder="porta" />
          <label>Usu√°rio</label>
          <input id="muser" type="text" placeholder="username" />
          <label>Senha</label>
          <input id="mpass" type="password" placeholder="password" />
          <label>Topic comando (ex: cmnd/tasmota_DF92AC/POWER)</label>
          <input id="topicCmd" type="text" value="cmnd/tasmota_DF92AC/POWER" />
          <label>Topic estado (ex: stat/tasmota_DF92AC/POWER)</label>
          <input id="topicStat" type="text" value="stat/tasmota_DF92AC/POWER" />
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="connectBtn">Conectar</button>
            <button id="sendBtn" disabled>Enviar ON/OFF</button>
          </div>
          <div id="connStatus" class="status muted">Desconectado</div>
        </div>
      </div>

      <div class="group" style="margin-top:12px;">
        <div class="label">Status da l√¢mpada</div>
        <div id="lampStatus" class="status muted">Desligado</div>
      </div>

      <div class="group" style="margin-top:12px;">
        <div class="label">Dicas</div>
        <div style="font-size:13px;margin-top:6px;color:var(--muted);">
          - Para usar MQTT via WebSocket, o broker precisa suportar conex√µes websocket (HiveMQ demo, Mosquitto com websockets, EMQX, etc.)<br>
          - Insira o endere√ßo como <code>ws://host:porta/mqtt</code> ou <code>wss://...</code>.<br>
          - O bot√£o "Enviar" enviar√° o payload <code>ON</code> ou <code>OFF</code> para o topic de comando.
        </div>
      </div>
    </aside>
  </div>

  <script>
    // -- UI bindings
    const card = document.getElementById('card');
    const sw = document.getElementById('switch');
    const knob = document.getElementById('knob');
    const glow = document.getElementById('glow');
    const filament = document.getElementById('filament');
    const brightness = document.getElementById('brightness');
    const brightVal = document.getElementById('brightVal');
    const color = document.getElementById('color');
    const lampStatus = document.getElementById('lampStatus');

    let isOn = false;
    let currentColor = '#ffd166';
    let currentBri = 100;

    function applyVisuals(){
      // glow intensity depends on brightness and on/off
      const b = isOn ? currentBri/100 : 0;
      const rgb = hexToRgb(currentColor);
      glow.style.background = `radial-gradient(circle at 50% 35%, rgba(${rgb.r},${rgb.g},${rgb.b},${0.28*b}), transparent 40%)`;
      glow.style.opacity = b>0 ? Math.max(0.12, b) : 0;
      // filament stroke color
      Array.from(filament.querySelectorAll('path')).forEach(p=>{
        p.style.stroke = `rgba(${rgb.r},${rgb.g},${rgb.b},${0.95})`;
        p.style.opacity = isOn ? (0.4 + 0.6*(currentBri/100)) : 0;
      });
      knob.textContent = isOn ? 'üîÜ' : 'üí°';
      lampStatus.textContent = isOn ? `Ligado ‚Äî ${Math.round(currentBri)}%` : 'Desligado';
    }

    function setState(on){ isOn = !!on; card.classList.toggle('on', isOn); sw.classList.toggle('on', isOn); sw.setAttribute('aria-pressed', String(!!on)); applyVisuals(); }

    sw.addEventListener('click', ()=>{ toggle(); if(client && client.isConnected()) publishCmd(isOn ? 'ON' : 'OFF'); });
    sw.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); if(client && client.isConnected()) publishCmd(isOn ? 'ON' : 'OFF'); } });

    function toggle(){ setState(!isOn); }

    brightness.addEventListener('input', ()=>{ currentBri = Number(brightness.value); brightVal.textContent = `${currentBri}%`; applyVisuals(); if(client && client.isConnected()){ publishAttr('brightness', currentBri); } });
    color.addEventListener('input', ()=>{ currentColor = color.value; applyVisuals(); if(client && client.isConnected()){ publishAttr('color', currentColor); } });

    // helpers
    function hexToRgb(hex){ const h = hex.replace('#',''); const bigint = parseInt(h,16); return { r: (bigint>>16)&255, g: (bigint>>8)&255, b: bigint&255 }; }

    // initialize
    currentColor = color.value; currentBri = Number(brightness.value); applyVisuals();

    // -- MQTT over WebSocket (Paho)
    // Load Paho dynamically
    function loadPaho(cb){ if(window.Paho) return cb(); const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js'; s.onload = cb; document.head.appendChild(s); }

    let client = null;
    const connectBtn = document.getElementById('connectBtn');
    const sendBtn = document.getElementById('sendBtn');
    const brokerInput = document.getElementById('broker');
    const portInput = document.getElementById('port');
    const userInput = document.getElementById('muser');
    const passInput = document.getElementById('mpass');
    const topicCmd = document.getElementById('topicCmd');
    const topicStat = document.getElementById('topicStat');
    const connStatus = document.getElementById('connStatus');

    function setConnStatus(text, ok){ connStatus.textContent = text; connStatus.style.background = ok ? 'rgba(0,0,0,0.04)' : 'transparent'; }

    connectBtn.addEventListener('click', ()=>{
      if(client && client.isConnected && client.isConnected()){
        client.disconnect(); updateUiDisconnected(); return;
      }
      loadPaho(()=>{
        try{
          const broker = brokerInput.value.trim();
          if(!broker){ alert('Informe o broker WebSocket (ws:// or wss://)'); return; }
          // extract host path for client connect
          // Paho requires host, port, path; try to parse
          const url = new URL(broker);
          const host = url.hostname; const port = url.port || (url.protocol === 'wss:'? '443':'80'); const path = url.pathname + (url.search||'');
          const clientId = 'webclient_' + Math.random().toString(16).slice(2,10);
          client = new Paho.MQTT.Client(host, Number(port), path, clientId);
          client.onConnectionLost = onConnectionLost;
          client.onMessageArrived = onMessageArrived;
          const options = {
            useSSL: url.protocol === 'wss:',
            onSuccess: onConnect,
            onFailure: onFail
          };
          const user = userInput.value.trim(); const pass = passInput.value;
          if(user) options.userName = user; if(pass) options.password = pass;
          client.connect(options);
          setConnStatus('Conectando...');
        }catch(err){ alert('Erro ao conectar: ' + err.message); }
      });
    });

    function onConnect(){
      setConnStatus('Conectado', true); sendBtn.disabled = false; connectBtn.textContent = 'Desconectar';
      // subscribe to status topic
      const sTopic = topicStat.value.trim(); if(sTopic) client.subscribe(sTopic);
    }
    function onFail(err){ setConnStatus('Falha na conex√£o: ' + (err.errorMessage||err)); }
    function onConnectionLost(responseObject){ setConnStatus('Conex√£o perdida'); sendBtn.disabled = true; connectBtn.textContent = 'Conectar'; }
    function onMessageArrived(message){ const t = message.destinationName; const p = message.payloadString; // update UI if matches status
      if(t === topicStat.value.trim()){ // muitos dispositivos enviam "ON"/"OFF" ou JSON
        if(p.toUpperCase().includes('ON')) setState(true); else if(p.toUpperCase().includes('OFF')) setState(false);
        lampStatus.textContent = isOn ? `Ligado ‚Äî ${Math.round(currentBri)}%` : 'Desligado';
      }
    }
    function updateUiDisconnected(){ setConnStatus('Desconectado'); sendBtn.disabled = true; connectBtn.textContent = 'Conectar'; }

    function publishCmd(payload){ if(!client || !client.isConnected()) return; const msg = new Paho.MQTT.Message(String(payload)); msg.destinationName = topicCmd.value.trim(); client.send(msg); }
    function publishAttr(attr, value){ if(!client || !client.isConnected()) return; const t = topicCmd.value.trim(); const msg = new Paho.MQTT.Message(String(value)); msg.destinationName = t; client.send(msg); }

    sendBtn.addEventListener('click', ()=>{
      if(!client || !client.isConnected()){ alert('N√£o conectado'); return; }
      const payload = isOn ? 'ON' : 'OFF'; publishCmd(payload);
    });

    // on page unload try disconnect
    window.addEventListener('beforeunload', ()=>{ try{ if(client && client.isConnected) client.disconnect(); }catch(e){} });

    // expose for debugging
    window.lamp = { set:on=>setState(on), toggle, publishCmd };
  </script>
</body>
</html>
